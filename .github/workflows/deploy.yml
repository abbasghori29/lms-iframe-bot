name: Deploy to EC2

on:
  push:
    branches:
      - main
  workflow_dispatch: # Allows manual triggering

jobs:
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate Secrets
        run: |
          if [ -z "${{ secrets.EC2_SSH_KEY }}" ]; then
            echo "‚ùå Error: EC2_SSH_KEY secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.EC2_HOST }}" ]; then
            echo "‚ùå Error: EC2_HOST secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.EC2_USER }}" ]; then
            echo "‚ùå Error: EC2_USER secret is not set"
            exit 1
          fi
          echo "‚úÖ All required secrets are set"
          echo "üìç Connecting to: ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}"

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to EC2
        env:
          EC2_USER: ${{ secrets.EC2_USER }}
          EC2_HOST: ${{ secrets.EC2_HOST }}
          APP_DIR: ${{ secrets.EC2_APP_DIR || '/home/ec2-user/lms-bot' }}
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          PINECONE_API_KEY: ${{ secrets.PINECONE_API_KEY }}
        run: |
          if [ -z "$EC2_HOST" ] || [ -z "$EC2_USER" ]; then
            echo "‚ùå Error: EC2_HOST or EC2_USER is empty"
            echo "EC2_HOST: ${EC2_HOST:-'NOT SET'}"
            echo "EC2_USER: ${EC2_USER:-'NOT SET'}"
            exit 1
          fi
          echo "üîó Connecting to $EC2_USER@$EC2_HOST..."
          
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -o ConnectTimeout=10 \
            $EC2_USER@$EC2_HOST \
            "export APP_DIR='${APP_DIR:-/home/ec2-user/lms-bot}' && \
             export GROQ_KEY='$GROQ_API_KEY' && \
             export PINECONE_KEY='$PINECONE_API_KEY' && \
             bash" << 'DEPLOY_SCRIPT'
          set -e
          cd "$APP_DIR"
          
          echo "üîÑ Pulling latest code..."
          git fetch origin
          git reset --hard origin/main
          
          echo "üìù Creating/updating .env file..."
          SECRET_RANDOM=$(openssl rand -hex 32)
          cat > .env << EOF
          # Application Settings
          PROJECT_NAME=LMS Bot
          VERSION=0.1.0
          DEBUG=False
          HOST=0.0.0.0
          PORT=8005
          
          # Database
          DATABASE_URL=sqlite:///./app.db
          DB_ECHO=False
          
          # Security
          SECRET_KEY=change-this-in-production-$SECRET_RANDOM
          ALGORITHM=HS256
          ACCESS_TOKEN_EXPIRE_MINUTES=30
          
          # CORS
          BACKEND_CORS_ORIGINS=["http://localhost:3000","http://localhost:8005"]
          
          # Logging
          LOG_LEVEL=INFO
          LOG_FORMAT=json
          
          # LLM / AI
          GROQ_API_KEY=$GROQ_KEY
          VECTOR_STORE_PATH=faiss_index
          EMBEDDING_API_URL=https://lamhieu-lightweight-embeddings.hf.space/v1/embeddings
          EMBEDDING_MODEL=bge-m3
          
          # Pinecone Vector Database
          PINECONE_API_KEY=$PINECONE_KEY
          PINECONE_INDEX_NAME=cafs-chatbot-memory
          PINECONE_CLOUD=aws
          PINECONE_REGION=us-east-1
          
          # Speech-to-Text
          WHISPER_MODEL=base
          EOF
          chmod 600 .env
          
          echo "üì¶ Activating virtual environment..."
          source venv/bin/activate
          
          echo "üì• Installing/updating dependencies..."
          pip install --upgrade pip
          pip install -r requirements.txt
          
          echo "üîÑ Restarting application service..."
          sudo systemctl daemon-reload
          sudo systemctl restart lms-bot || echo "‚ö†Ô∏è  Service might not exist yet, continuing..."
          
          echo "‚úÖ Deployment completed!"
          echo "üìä Service status:"
          sudo systemctl status lms-bot --no-pager || echo "‚ö†Ô∏è  Service status unavailable"
          DEPLOY_SCRIPT

      - name: Health Check
        run: |
          sleep 5
          curl -f http://${{ secrets.EC2_HOST }}:8005/health || echo "‚ö†Ô∏è  Health check failed, but deployment completed"
