name: Deploy to EC2

on:
  push:
    branches:
      - main
  workflow_dispatch: # Allows manual triggering

jobs:
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate Secrets
        run: |
          if [ -z "${{ secrets.EC2_SSH_KEY }}" ]; then
            echo "‚ùå Error: EC2_SSH_KEY secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.EC2_HOST }}" ]; then
            echo "‚ùå Error: EC2_HOST secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.EC2_USER }}" ]; then
            echo "‚ùå Error: EC2_USER secret is not set"
            exit 1
          fi
          echo "‚úÖ All required secrets are set"
          echo "üìç Connecting to: ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}"

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to EC2
        env:
          EC2_USER: ${{ secrets.EC2_USER }}
          EC2_HOST: ${{ secrets.EC2_HOST }}
          APP_DIR: ${{ secrets.EC2_APP_DIR || '/home/ec2-user/lms-bot' }}
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          PINECONE_API_KEY: ${{ secrets.PINECONE_API_KEY }}
          REPO_URL: ${{ github.event.repository.clone_url }}
        run: |
          if [ -z "$EC2_HOST" ] || [ -z "$EC2_USER" ]; then
            echo "‚ùå Error: EC2_HOST or EC2_USER is empty"
            echo "EC2_HOST: ${EC2_HOST:-'NOT SET'}"
            echo "EC2_USER: ${EC2_USER:-'NOT SET'}"
            exit 1
          fi
          echo "üîó Connecting to $EC2_USER@$EC2_HOST..."
          
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -o ConnectTimeout=10 \
            $EC2_USER@$EC2_HOST \
            "export APP_DIR='${APP_DIR:-/home/ec2-user/lms-bot}' && \
             export REPO_URL='$REPO_URL' && \
             export GROQ_KEY='$GROQ_API_KEY' && \
             export PINECONE_KEY='$PINECONE_API_KEY' && \
             export EC2_USER_NAME='$EC2_USER' && \
             bash" << 'DEPLOY_SCRIPT'
          set -e
          
          echo "üöÄ Starting automated setup and deployment..."
          
          # Detect OS and install prerequisites
          if [ -f /etc/os-release ]; then
            . /etc/os-release
            OS=$ID
          else
            echo "‚ö†Ô∏è  Cannot detect OS, assuming Amazon Linux"
            OS="amzn"
          fi
          
          echo "üì¶ Installing system prerequisites for $OS..."
          
          if [ "$OS" = "amzn" ] || [ "$OS" = "rhel" ] || [ "$OS" = "centos" ]; then
            # Amazon Linux / RHEL / CentOS
            sudo yum update -y
            sudo yum install -y git python3.11 python3.11-pip python3.11-devel gcc gcc-c++ make cmake
            # Try to install ffmpeg if available
            sudo yum install -y ffmpeg ffmpeg-devel 2>/dev/null || echo "‚ö†Ô∏è  ffmpeg not available in default repos, skipping"
          elif [ "$OS" = "ubuntu" ] || [ "$OS" = "debian" ]; then
            # Ubuntu / Debian
            sudo apt-get update -y
            sudo apt-get install -y git python3.11 python3.11-venv python3.11-dev python3-pip build-essential gcc g++ make cmake
            sudo apt-get install -y ffmpeg libavcodec-dev libavformat-dev libavutil-dev 2>/dev/null || echo "‚ö†Ô∏è  ffmpeg installation failed, continuing"
          else
            echo "‚ö†Ô∏è  Unknown OS, trying to install basic packages..."
            sudo yum install -y git python3 python3-pip 2>/dev/null || sudo apt-get install -y git python3 python3-pip 2>/dev/null || true
          fi
          
          # Verify Python is available
          if command -v python3.11 &> /dev/null; then
            PYTHON_CMD=python3.11
          elif command -v python3 &> /dev/null; then
            PYTHON_CMD=python3
          else
            echo "‚ùå Python not found!"
            exit 1
          fi
          
          echo "‚úÖ Python found: $PYTHON_CMD"
          $PYTHON_CMD --version
          
          # Create directory if it doesn't exist
          if [ ! -d "$APP_DIR" ]; then
            echo "üìÅ Creating application directory: $APP_DIR"
            mkdir -p "$APP_DIR"
            cd "$APP_DIR"
            
            echo "üì• Cloning repository (first time setup)..."
            git clone "$REPO_URL" .
          else
            echo "üìÇ Directory exists, updating code..."
            cd "$APP_DIR"
            
            echo "üîÑ Pulling latest code..."
            git fetch origin
            git reset --hard origin/main
          fi
          
          echo "üìù Creating/updating .env file..."
          SECRET_RANDOM=$(openssl rand -hex 32)
          cat > .env << EOF
          # Application Settings
          PROJECT_NAME=LMS Bot
          VERSION=0.1.0
          DEBUG=False
          HOST=0.0.0.0
          PORT=8005
          
          # Database
          DATABASE_URL=sqlite:///./app.db
          DB_ECHO=False
          
          # Security
          SECRET_KEY=change-this-in-production-$SECRET_RANDOM
          ALGORITHM=HS256
          ACCESS_TOKEN_EXPIRE_MINUTES=30
          
          # CORS
          BACKEND_CORS_ORIGINS=["http://localhost:3000","http://localhost:8005"]
          
          # Logging
          LOG_LEVEL=INFO
          LOG_FORMAT=json
          
          # LLM / AI
          GROQ_API_KEY=$GROQ_KEY
          VECTOR_STORE_PATH=faiss_index
          EMBEDDING_API_URL=https://lamhieu-lightweight-embeddings.hf.space/v1/embeddings
          EMBEDDING_MODEL=bge-m3
          
          # Pinecone Vector Database
          PINECONE_API_KEY=$PINECONE_KEY
          PINECONE_INDEX_NAME=cafs-chatbot-memory
          PINECONE_CLOUD=aws
          PINECONE_REGION=us-east-1
          
          # Speech-to-Text
          WHISPER_MODEL=base
          EOF
          chmod 600 .env
          
          echo "üì¶ Setting up virtual environment..."
          if [ ! -d "venv" ]; then
            echo "üêç Creating virtual environment..."
            $PYTHON_CMD -m venv venv
          fi
          
          echo "üì¶ Activating virtual environment..."
          source venv/bin/activate
          
          echo "üì• Installing/updating dependencies..."
          pip install --upgrade pip setuptools wheel
          pip install -r requirements.txt
          
          echo "üìö Checking vector store..."
          if [ ! -d "faiss_index" ]; then
            echo "‚ö†Ô∏è  Vector store (faiss_index) not found!"
            if [ -f "FIC-CSI-EN-2025.pdf" ] && [ -f "PDF complet de CSI.pdf" ]; then
              echo "üìÑ PDF files found, creating vector store (this will take several minutes)..."
              echo "   This is a one-time process that creates embeddings from PDFs."
              python train_vector_db.py || echo "‚ö†Ô∏è  Vector store creation failed, but continuing deployment"
            else
              echo "‚ùå ERROR: Vector store not found and PDF files are missing!"
              echo "   The chatbot will not work without the vector store."
              echo "   You need to either:"
              echo "   1. Upload the faiss_index directory to EC2, or"
              echo "   2. Upload PDF files and run: python train_vector_db.py"
            fi
          else
            echo "‚úÖ Vector store found"
          fi
          
          echo "‚öôÔ∏è  Setting up systemd service..."
          # Use the EC2 user from environment
          SERVICE_USER=${EC2_USER_NAME:-$(whoami)}
          # Create systemd service file
          sudo tee /etc/systemd/system/lms-bot.service > /dev/null << SERVICE_EOF
          [Unit]
          Description=LMS Bot FastAPI Application
          After=network.target
          
          [Service]
          Type=simple
          User=$SERVICE_USER
          Group=$SERVICE_USER
          WorkingDirectory=$APP_DIR
          Environment="PATH=$APP_DIR/venv/bin"
          ExecStart=$APP_DIR/venv/bin/uvicorn app.main:app --host 0.0.0.0 --port 8005 --workers 4
          Restart=always
          RestartSec=10
          StandardOutput=journal
          StandardError=journal
          
          # Security settings
          NoNewPrivileges=true
          PrivateTmp=true
          
          [Install]
          WantedBy=multi-user.target
          SERVICE_EOF
          
          # Reload systemd and enable/start service
          sudo systemctl daemon-reload
          sudo systemctl enable lms-bot
          sudo systemctl restart lms-bot
          
          echo "‚úÖ Deployment completed!"
          echo "üìä Service status:"
          sudo systemctl status lms-bot --no-pager -l || echo "‚ö†Ô∏è  Service status unavailable"
          
          echo ""
          echo "üìã Checking service logs (last 30 lines) for errors:"
          sudo journalctl -u lms-bot -n 30 --no-pager || echo "‚ö†Ô∏è  Could not read logs"
          
          echo ""
          echo "üîç Checking if port 8005 is listening:"
          sudo netstat -tulpn | grep 8005 || sudo ss -tulpn | grep 8005 || echo "‚ö†Ô∏è  Port 8005 not found in listening ports"
          
          echo ""
          echo "üìÅ Checking vector store directory:"
          if [ -d "$APP_DIR/faiss_index" ]; then
            echo "‚úÖ Vector store directory exists"
            ls -la "$APP_DIR/faiss_index" | head -5
          else
            echo "‚ùå WARNING: Vector store directory (faiss_index) not found!"
            echo "   The chatbot will not work without the vector store."
            echo "   You need to either:"
            echo "   1. Upload faiss_index directory to EC2, or"
            echo "   2. Run train_vector_db.py on EC2 to create it"
          fi
          
          echo ""
          echo "üîë Checking environment variables:"
          if [ -f "$APP_DIR/.env" ]; then
            echo "‚úÖ .env file exists"
            if grep -q "GROQ_API_KEY=" "$APP_DIR/.env" && ! grep -q "GROQ_API_KEY=$" "$APP_DIR/.env" && ! grep -q "GROQ_API_KEY=your-" "$APP_DIR/.env"; then
              echo "‚úÖ GROQ_API_KEY appears to be set"
            else
              echo "‚ùå WARNING: GROQ_API_KEY may not be set correctly"
            fi
          else
            echo "‚ùå .env file not found!"
          fi
          
          echo ""
          echo "üåê Application should be available at: http://$(curl -s http://169.254.169.254/latest/meta-data/public-ipv4 2>/dev/null || echo 'EC2_IP'):8005"
          echo ""
          echo "‚ö†Ô∏è  IMPORTANT: Make sure your EC2 Security Group allows inbound traffic on port 8005!"
          echo "   - Type: Custom TCP"
          echo "   - Port: 8005"
          echo "   - Source: 0.0.0.0/0 (or your specific IP)"
          DEPLOY_SCRIPT

      - name: Health Check
        continue-on-error: true
        timeout-minutes: 2
        run: |
          echo "‚è≥ Waiting for application to start..."
          sleep 15
          echo "üè• Checking application health..."
          echo "üìç Attempting to connect to http://${{ secrets.EC2_HOST }}:8005/health"
          curl -v --max-time 10 --connect-timeout 5 http://${{ secrets.EC2_HOST }}:8005/health && echo "‚úÖ Health check passed!" || echo "‚ö†Ô∏è  Health check failed - Check: 1) Security group allows port 8005, 2) Service logs for errors, 3) Application is running"
